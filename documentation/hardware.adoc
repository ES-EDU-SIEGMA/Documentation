= Hardware
:icons: font
:toc: top
:toclevels: 4
:stem:
:imagesdir: images
:figure-caption!:

The Drink Mixing Machine consists of several hardware parts.
There can be grouped into three categories, namely:

* <<Frame,Frame>>
* <<Dispenser Components,Dispenser Components>>
* <<Controlling Components,Controlling Components>>

== Frame

The frame is build from aluminium bases system profiles.

image::alu-profile.png[title="Alu System Profile", width=150]

== Dispenser Components

The dispenser group consists of multiple components arranged around a standard bar dispenser as seen in <<dispenser-img,Dispenser Image>>.

image::dispenser.jpg[title="Bar Dispenser", width=300, id=dispenser-img]

The dispenser is actuated by a 3D-printed arm which is lifted with a construction of ropes and pulleys powered by a stepper motor as the winch.

=== Metrics

.Manual Operation
====
3 to 5 seconds for the Dispenser to drain the liquid +
**=> 4 to 6 seconds to empty the Dispenser**
====

.With the Machine
====
With a `VACTUAL` (<<TMC2209>>) of 5000 latexmath:[\frac{\mu\text{-steps}}{\text{second}}], the dispenser requires 8 seconds to move up and 8 to move down +
**=> latexmath:[\geq] 16 seconds to empty a Dispenser**

The highest speed that the motor can achieve is `VACTUAL` = 150000 latexmath:[\frac{\mu\text{-steps}}{t}]. With this speed it takes only 6.5 seconds to empty and refill a 4 cl Dispenser.
However, these speeds can only be achieved with a more stable mechanical system. 
Currently, the plastic bottle holders bend to much at higher speeds.
If the dispensers are held from above when starting the motor, it is possible to start up with 150000 latexmath:[\frac{\mu\text{-steps}}{t}]. 
Metal components with a proper attachment to the machine might fix this problem.

IMPORTANT: The current mechanical system allows for speeds of up to  `VACTUAL` = 100000 latexmath:[\frac{\mu\text{-steps}}{t}] for reliable emptying of the dispenser. +
**=> 8 seconds to empty a Dispener**

CAUTION: Slow movement when closing is required in order to assure that the Dispenser is refilled. 
`VACTUAL` = 100000 latexmath:[\frac{\mu\text{-steps}}{t}] should not be exceeded.
====

.Estimated Times to fill a 250ml glass
|===
|Dispenser |Manual Operation |Machine `VACTUAL`=50000 |Machine `VACTUAL`=100000

|3cl |30s |90s |45s

|4cl |24s |72s |36s

|5cl |18s |54s |27s
|===

TIP: 5cl Dispenser can significantly reduce the time required to dispense liquids with large amounts.

==== Real World Test

.Mixing a Cocktail with 5 ingredients:
- 3 ingredients require 2cl each
- 2 ingredients require 10cl each

-> two runs are required with each 18 seconds +
**=> 36 seconds**

=== Improvements

The accuracy of the dispensing mechanism mostly depends on the volume of the dispenser.
Due to hardware restrictions it is extremely difficult to precisely empty the dispenser only partially.

TIP: After improvements to the movement speeds of the motor experiments should take place, that evaluates the possibilty of emptying the dispenser only partially.

== Controlling Components

The controlling components of the machine are a Raspberry Pi (as the main controller) combined with a custom PCB that features a Tiny2040 as a controller for up to 4 stepper drivers and multiple sensors.

image::schematic.png[title="Machine Schematic"]

=== Raspberry Pi

The Raspberry Pi provides the GUI for the user and holds the required database for the drinks and ingredients.

The Tiny2040 on the PCBs are connected to the Raspberry Pi via a serial port which are mapped dynamically during runtime.

The scale under the jar is directly connected to the Raspberry Pi via GPIOs.

==== Scale

The scale unit consists of a beam scale combined with an ADC.

[horizontal]
Beam Scale::
    The beam scale provides us with a continues analogue signal that has to be converted to a digital signal.
ADC::
    The ADC converts the analogue signal from the beam scale to a digital signal, that can be used by interpreted digital GPIO pins of the Raspberry PI.
    The Drink mixing machine utilizes the HX711 ADC chip, which is specialized in converting analogue data from a scale.
HX711:::
    The HX711 can be used with a throughput of 10 *or* 80 samples per second and provides a active low noise programmable gain amplifier (gain = 32, 64, 128).
    Each sample consists of a 24 bit value provided in twos-complement.
Software::
    The software library used is  the https://github.com/tatobari/hx711py[tatobari/hx711py] library.
    To get correct values from the scale the library requires the user to specify a `REFERENCE_UNIT`.
    This value is the factor that scales the received value and has to be determined by experimentation with the setup, as described in https://github.com/tatobari/hx711py/blob/master/example.py[libraries example.py].

IMPORTANT: `REFERENCE_UNIT` has to be reevaluated when the module is changed *or* when the chip is changed!

=== PCB

NOTE: The Eagle project files can be found the https://github.com/ES-EDU-SIEGMA/Embedded-Controller/tree/main/PCB[Embedded-Controller Repository]

The PCB is custom made for this machine.

image::PCB.svg[title="PCB", width=500]

image::Schematics.svg[title="Schematics", width=500]

[horizontal]
CONTROLLER::
    Tiny2040 Compute Module
POWER_CONNECTOR::
    Power connection for the PCB
S1-S4::
    Endpoints for sensor connections
LED::
    LED for LDR sensor of the rondell
UART_1::
    Debug point for the one-wire UART to the TMC Motor Drivers
SPI_I2C::
    Breakouts to connect the Tiny2040 via SPI or I^2^C to the Raspberry Pi

.Datasheets
* link:../datasheets/TMC2209_datasheet_rev1.09.pdf[TMC2209]
* link:../datasheets/TMC2209_SilentStepStick_Rev110.pdf[TMC2209 SilentStepKick Board]
* link:https://shop.pimoroni.com/products/tiny-2040[Tiny2040]
* link:../datasheets/rp2040-datasheet.pdf[RP2040]

==== TMC2209

The stepper motors are currently operated using the `VELOCITY DEPENDENT DRIVER FEATURE CONTROL REGISTER`.
So far the motors have been operated at a speed `VACTUAL` of 50000 latexmath:[\frac{\mu\text-steps}{t}], with a CLK frequency of 12 MHz each step would take latexmath:[t=2^{24}\cdot CLK^{1}	=	1.398101] seconds.

NOTE: With this speed the motor needs 8 seconds to fully open the dispenser.

The latexmath:[\mu\text{-steps}] velocity v in Hertz can be determined using the formula:
[latexmath]
++++
v = \frac{VACTUAL \cdot CLK}{2^{24}}
++++

To determine how many latexmath:[\mu\text{-steps}] it takes the motor to fully open the dispenser, the following formula is used.

[latexmath]
++++
v \cdot t
++++

[example]
====
For `CLK` frequency of 12MHZ and a `VACTUAL` of 50000 the formula is:
[latexmath]
++++
v = 50000 \cdot 0.715Hz = 35762.79\frac{\mu\text{-steps}}{\text{second}}
++++

Therefore 
[latexmath]
++++
8\;\text{seconds}\cdot v = 8\;\text{seconds}\cdot 35762.79\frac{\mu\text{-steps}}{\text{second}} = 286102\mu\text{-steps}
++++
are required to fully open of the dispenser.
====



