= Hardware
:hardbreaks:
:icons: font

The Drink Mixing Machine consists of several hardware parts.
There can be grouped into three categories, namely:

* <<Frame,Frame>>
* <<Dispenser Components,Dispenser Components>>
* <<Controlling Components,Controlling Components>>

== Frame

The frame is build from aluminium bases system profiles.

image::images/alu-profile.png[title="Alu System Profile", width=300]

== Dispenser Components

The disepenser group consists of multiple components arranged around a standard bar dispenser as seen in image.

image::images/dispenser.jpg[title="Bar Dispenser", width=300]

The dispenser is actuated by a 3D-printed arm which is lifted with a construction of ropes and deflection spools powerd by a stepper motor as the winch.

=== Metrics

.Manual Operation
====
3 to 5 seconds for the Dispenser to drain the liquid
=> 4 to 6 seconds to empty the Dispenser
====

.With the Machine
====

With VACTUAL (see <<TMC2209,TMC2209>>) of 50000 μstep/t, the dispenser requires 8 seconds to move up/down => 16 seconds to empty a Dispenser.

The highest speed that the motor can achieve is VACTUAL=150000 μstep/t. With this speed it takes only 6.5 seconds to empty and refill a 4 cl Dispenser.
However, these speeds can only be achieved with a more stable mechanical system. Currently, the plastic bottle holders bend so much at higher speeds that the dispensers cant. If the dispensers are held from above when starting the motor, it is possible to start up with 150000 μstep/t. Metal bottle holder with a proper attachment to the machine might fix the problem.

The current mechanical system allows for a speed of VACTUAL=100000 μstep/t for reliable emptying of the dispenser. => 8 seconds to empty a Dispener.

CAUTION: Slow movement when closing is required in order to assure that the Dispenser is refilled. VACTUAL=100000 μstep/t should not be exceeded.
====

.Estimated Times to fill a ~250ml glass
|===
|Dispenser |Manual Operation |Machine VACTUAL=50000 |Machine VACTUAL=100000

|3cl |30s |90s |45
|4cl |24s |72s |36
|5cl |18s |54s |27
|===

TIP: 5cl Dispenser can significantly reduce the time required to dispense liquids which large amounts

==== Real World Test

.Mixing a Cocktail with 5 ingredients:
- 3 ingredients require 2cl each
- 2 ingredients require 10cl each

-> two runs are required with each 18 seconds => 36 seconds

== Controlling Components

The group of controlling components consits of a Raspberry Pi as the main controller of the machine combined with a custom PCB that has a Tiny2040 as a sub controller which controlls up to 4 stepper driver and sensors.

=== PCB

The PCB is custom made for the purpose of providing a controller that combines sensors and stepper drivers.

image::images/schematic.png[title="Schematic"]

image::images/pcb-layout.png[title="PCB", width=500]

[NOTE]
.Rondell
====
[horizontal]
TINY2040::
  Tiny2040
POWER_CON::
  Power connection for the components
U1::
  Dispenser
U3::
  Rondell
LS4::
  Dispenser switch
LS3::
  light dependent resistor (LDR) of the rondell
LED::
  LED for LDR sensor of the rondell
====

[NOTE]
.Left/Right
====
The TMC2209 and sensors are connected regarding the number and the labels on the machine
====

.Datasheets
* link:../datasheets/TMC2209_datasheet_rev1.09.pdf[TMC2209]
* link:../datasheets/TMC2209_SilentStepStick_Rev110.pdf[TMC2209 SilentStepKick Board]
* link:https://shop.pimoroni.com/products/tiny-2040[Tiny2040]
* link:../datasheets/rp2040-datasheet.pdf[RP2040]

=== TMC2209
The stepper motors are currently operated using the VELOCITY DEPENDENT DRIVER FEATURE CONTROL REGISTER.
So far the motors have been operated at a speed of 

* VACTUAL = 50000 μstep/t. (with fCLK = 12 MHZ -> t	=	 2^24/fCLK	=	1,398101	[sec]).

With this speed the motor needs 8 seconds to fully open the dispenser.

To determine how many μsteps it takes the motor to fully open the dispenser, the following formula is used.

* The μstep velocity v[Hz] can be determined using the formula 

** v[Hz] = VACTUAL[2209] * ( fCLK[Hz] / 2^24 ).

* For fCLK = 12MHZ the formula is: v[Hz] = VACTUAL[2209] * 0.715Hz.

With a VACTUAL of 50000, you have 35762.79 µSteps/s.

Accordingly, 8s x v[Hz] = 8s x 35762.79 µSteps/s = 286102 µSteps are required for the complete open of the dispenser.

=== Raspberry Pi

The Raspberry Pi provides the GUI for the user and holds the required database for the drinks.
The Tiny2040 on the PCBs are connected via a serial port which is mapped dynmically during runtime.
The scale under the jar is directly connected to the Raspberry Pis GPIOs.

